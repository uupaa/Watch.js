<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - lib/Watch.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome-ie7.css" rel="stylesheet">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet">
  <link href="../../assets/css/plato.css" rel="stylesheet">
  <link href="../../assets/css/plato-file.css" rel="stylesheet">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="http://github.com/es-analysis/plato">Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>lib/Watch.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">69.39</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">245</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">47.02</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">1.69</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">// @name: Watch.js
// @require: Sort.js

(function(global) {

// --- variable --------------------------------------------
var _inNode = &quot;process&quot; in global;
var fs      = require(&quot;fs&quot;);
var Sort    = require(&quot;../node_modules/uupaa.sort.js/lib/Sort&quot;);

// --- define ----------------------------------------------
// console color
var _YELLOW = &quot;\u001b[33m&quot;;
var _CLR    = &quot;\u001b[0m&quot;;

// --- interface -------------------------------------------
function Watch(paths,      // @arg PathArray:
               options,    // @arg Object: { action, verbose, ... }
               callback) { // @arg Function: callback(err:Error):void
                           // @help: Watch
//{@assert
    _if(!Array.isArray(paths),  &quot;invalid Watch(paths)&quot;);
    _if(!_isObject(options),    &quot;invalid Watch(,options)&quot;);
    _if(!_isFunction(callback), &quot;invalid Watch(,,callback)&quot;);
//}@assert

    this._options = options || {};

    if (this._options.verbose) {
        console.log(&quot;  --- watch ---&quot;);
    }
    paths.forEach(function(path) {
        if (Watch_isFile(path)) {
            Watch_file(path, function(diff) { // { path: { dir, size, mtime }, ... }
                callback(null, diff);
            });
        } else if (Watch_isDir(path)) {
            Watch_dir(path, function(diff) { // { path: { dir, size, mtime }, ... }
                callback(null, diff);
            }, options);
        }
    });
}
Watch[&quot;name&quot;] = &quot;Watch&quot;;
Watch[&quot;repository&quot;] = &quot;https://github.com/uupaa/Watch.js&quot;;

//Watch.dir     = Watch_dir;      // Watch.dir(dir:String, fn:Function, options:Object):void
//Watch.scanDir = Watch_scanDir;  // Watch.scanDir(dir:String, options:Object):Object
Watch.isFile = Watch_isFile;
Watch.isDir  = Watch.isDir;

// --- implement -------------------------------------------
function Watch_file(watchFilePath, // @arg String: watch file path
                    callback) {    // @arg Function: callback(null):void
    var timerID = 0;

    console.log(&quot;    file    &quot; + watchFilePath);

    fs.watchFile(watchFilePath, _watchdogCallback);

    function _watchdogCallback() {
        if (timerID) {
            clearTimeout(timerID); timerID = 0;
        }
        timerID = setTimeout(function() {
            clearTimeout(timerID); timerID = 0;

            callback(null);
        }, 2000);
    }
}

function Watch_dir(watchRoorDir, // @arg String: watch root dir
                   callback,     // @arg Function: callback(diff:Object):void
                   options) {    // @arg Object: { ... }
                                 //      diff - Object: { path: { dir, size, mtime }, ... }
    var timerID = 0;
    var keepDirTrees = Watch_scanDir(watchRoorDir, options); // { dirs, files }

    for (var path in keepDirTrees.dirs) {
        console.log(&quot;    dir     &quot; + path);
        fs.watch(path, _watchdogCallback);
    }

    function _watchdogCallback() {
        if (timerID) {
            clearTimeout(timerID); timerID = 0;
        }

        // -&gt; sleep(1000)
        // -&gt; scanDir(watchRootDir)
        // -&gt; get diff
        // -&gt; callback(diff)
        // -&gt; sleep...

        timerID = setTimeout(function() {
            var currentDirTrees = Watch_scanDir(watchRoorDir, options); // { dirs, files }
            var diff = _diff(currentDirTrees, keepDirTrees); // { path: { dir, size, mtime }, ... }

            keepDirTrees = currentDirTrees;

            clearTimeout(timerID); timerID = 0;

            callback(diff);
        }, 2000);
    }
}

function Watch_scanDir(scanRootDir, // @arg String: scan root dir
                       options) {   // @arg Object: { ... }
                                    // @ret Object: { dirs: {}, files: {} }
                                    //     dirs - Object: { dir:Boolean, size:Intger, mtime:Integre }
                                    //     files - Object: { dir:Boolean, size:Intger, mtime:Integre }
    var result = { dirs: {}, files: {} };
    var stat = fs.statSync(scanRootDir);
    var ignoreDir = options.ignoreDir || [];
    var found = false;

    if ( stat.isDirectory() ) {
        // found .watchignore ?
        if (ignoreDir.length) {
            found = ignoreDir.some(function(value) {
                        return Watch_isFile(scanRootDir + value);
                    });
        }
        if (found) {
            // ignore dir
        } else {
            result.dirs[scanRootDir] = {
                dir:   true,
                size:  stat.size,
                mtime: +stat.mtime
            };
            _readDir(result, scanRootDir, options);
        }
    }
    return result;
}

function _readDir(result,    // @arg Object: { dirs: {}, files: {} }
                  dir,       // @arg DirString:
                  options) { // @arg Object: { ... }
                             // @recursive:
    var fileList = fs.readdirSync(dir);
    var ignoreDir = options.ignoreDir || [];
    var ignoreFileNamePostFix = options.ignoreFileNamePostFix || [];

    Sort.nat(fileList).forEach(function(fname) {
        var path = dir + fname;
        var stat = fs.statSync(path);
        var found = false;

        if ( stat.isFile() ) {
            if (ignoreFileNamePostFix.length) {
                found = ignoreFileNamePostFix.some(function(value) {
                            return path.lastIndexOf(value) === path.length - value.length;
                        });
            }
            if (found) {
                // found *.min.js
            } else {
                result.files[path] = { dir: false, size: stat.size, mtime: +stat.mtime };
            }
        } else if ( stat.isDirectory() ) {
            path += &quot;/&quot;;
            // found .watchignore
            if (ignoreDir.length) {
                found = ignoreDir.some(function(value) {
                            return Watch_isFile(path + value);
                        });
            }

            if (found) {
                // ignore dir
            } else {
                result.dirs[path] = { dir: true, size: stat.size, mtime: +stat.mtime };
                _readDir(result, path, options); // recursive call
            }
        }
    });
}

function Watch_isFile(path) { // @arg String
                         // @ret Boolean:
    return fs.existsSync(path) &amp;&amp; fs.statSync(path).isFile();
}

function Watch_isDir(path) { // @arg String
                        // @ret Boolean:
    return fs.existsSync(path) &amp;&amp; fs.statSync(path).isDirectory();
}

function _diff(curt,   // @arg Object: current dir tree. { dirs, files }
               last) { // @arg Object: last dir tree.    { dirs, files }
                       // @ret Object: diff dir tree.    { path: { dir, size, mtime }, ... }
    var result = {};

    for (var path in curt.files) {
        if ( !_match( path, curt.files[path], last.files[path] ) ) {
            result[path] = curt.files[path];
        }
    }
    return result;
}

function _match(path,
                a,    // @arg Object: { dir, size, mtime }
                b) {  // @arg Object: { dir, size, mtime }
    if (a &amp;&amp; b) {
        if (a.dir === b.dir) {
            if (a.size === b.size) {
                if (a.mtime === b.mtime) {
                    return true;
                }
            }
        }
        console.log(&quot;    &quot; + _YELLOW + &quot;changed &quot; + _CLR + path);
    }
    return false;
}

//{@assert
function _isFunction(target) {
    return target !== undefined &amp;&amp; (typeof target === &quot;function&quot;);
}
function _isObject(target) {
    return target &amp;&amp; (target.constructor === ({}).constructor);
}
function _if(booleanValue, errorMessageString) {
    if (booleanValue) {
        throw new Error(errorMessageString);
    }
}
//}@assert

// --- export ----------------------------------------------
//{@node
if (_inNode) {
    module[&quot;exports&quot;] = Watch;
}
//}@node
if (global[&quot;Watch&quot;]) {
    global[&quot;Watch_&quot;] = Watch; // already exsists
} else {
    global[&quot;Watch&quot;]  = Watch;
}

})(this.self || global);</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
